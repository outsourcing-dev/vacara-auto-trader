<!-- 개선된 dashboard.html -->
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 관리 - Vacara Auto Trader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            font-size: .875rem;
            padding-top: 56px; /* 상단 네비게이션바 높이만큼 패딩 */
        }

        .navbar-brand {
            padding-top: .75rem;
            padding-bottom: .75rem;
            font-size: 1rem;
        }
        
        /* 테이블 헤더 중앙 정렬 */
        .table thead th {
            text-align: center;
            vertical-align: middle;
        }
        
        /* 테이블 셀 중앙 정렬 */
        .table tbody td {
            text-align: center;
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <header class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">Vacara Auto Trader</a>
        <div class="w-100"></div>
        <div class="navbar-nav">
            <div class="nav-item text-nowrap">
                <a class="nav-link px-3" href="#" id="logoutBtn">로그아웃</a>
            </div>
        </div>
    </header>

    <div class="container-fluid mt-4">
        <main class="px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">사용자 관리</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <button type="button" class="btn btn-sm btn-primary" id="addUserBtn" data-bs-toggle="modal" data-bs-target="#userModal">
                        <i class="bi bi-person-plus"></i> 사용자 추가
                    </button>
                </div>
            </div>

            <!-- 사용자 테이블 -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>NO</th>
                            <th>ID</th>
                            <th>비밀번호</th>
                            <th>이름</th>
                            <th>전화번호</th>
                            <th>추천인</th>
                            <th>사용 기간</th>
                            <th>남은 일수</th>
                            <th>최근 로그인</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- 여기에 사용자 목록이 동적으로 추가됩니다 -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- 사용자 추가/수정 모달 -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">사용자 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userAction" value="add">
                        <input type="hidden" id="userId" value="">
                        
                        <div class="mb-3">
                            <label for="userIdInput" class="form-label">아이디</label>
                            <input type="text" class="form-control" id="userIdInput" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="userPwInput" class="form-label">비밀번호</label>
                            <input type="text" class="form-control" id="userPwInput" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="userEndDate" class="form-label">사용 기간</label>
                            <input type="date" class="form-control" id="userEndDate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="userName" class="form-label">이름</label>
                            <input type="text" class="form-control" id="userName">
                        </div>
                        
                        <div class="mb-3">
                            <label for="userPhone" class="form-label">전화번호</label>
                            <input type="text" class="form-control" id="userPhone">
                        </div>
                        
                        <div class="mb-3">
                            <label for="userReferrer" class="form-label">추천인</label>
                            <input type="text" class="form-control" id="userReferrer">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="saveUserBtn">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 모달 -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">삭제 확인</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>정말로 이 사용자를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.</p>
                    <p>사용자 ID: <strong id="deleteUserId"></strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">삭제</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 모달 인스턴스 저장
        let userModal;
        let deleteModal;
        
        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', function () {
            // 모달 인스턴스 초기화
            userModal = new bootstrap.Modal(document.getElementById('userModal'));
            deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            
            // 사용자 목록 로드
            loadUsers();
            
            // 사용자 저장 버튼 이벤트
            document.getElementById('saveUserBtn').addEventListener('click', saveUser);
            
            // 사용자 추가 버튼 이벤트
            document.getElementById('addUserBtn').addEventListener('click', function() {
                resetUserForm('add');
            });
            
            // 삭제 확인 버튼 이벤트
            document.getElementById('confirmDeleteBtn').addEventListener('click', deleteUser);
            
            // 로그아웃 버튼 이벤트
            document.getElementById('logoutBtn').addEventListener('click', function () {
                localStorage.removeItem('access_token');
                window.location.href = '/login';
            });
        });

        // 토큰 확인
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return token;
        }

        // 사용자 목록 불러오기
        async function loadUsers() {
            const token = checkAuth();
            if (!token) return;

            try {
                const response = await fetch('/api/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('사용자 목록을 불러오는데 실패했습니다.');
                }

                const data = await response.json();
                const tableBody = document.getElementById('usersTableBody');
                tableBody.innerHTML = '';

                const today = new Date();

                data.users.forEach((user, index) => {
                    const endDate = new Date(user.end_date);
                    const diffTime = endDate.getTime() - today.getTime();
                    const daysLeft = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.id}</td>
                        <td>${user.pw}</td>
                        <td>${user.name || '-'}</td>
                        <td>${user.phone ? String(user.phone) : '-'}</td>
                        <td>${user.referrer || '-'}</td>
                        <td>${user.end_date}</td>
                        <td>${daysLeft}일</td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleString() : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-btn" data-user-id="${user.id}">수정</button>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-user-id="${user.id}">삭제</button>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });
                
                // 수정 버튼 이벤트 추가
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        editUser(this.getAttribute('data-user-id'));
                    });
                });
                
                // 삭제 버튼 이벤트 추가
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        showDeleteConfirmation(this.getAttribute('data-user-id'));
                    });
                });
            } catch (error) {
                console.error('사용자 목록 오류:', error);
            }
        }
        
        // 사용자 폼 초기화
        function resetUserForm(action) {
            document.getElementById('userForm').reset();
            document.getElementById('userAction').value = action;
            document.getElementById('userId').value = '';
            
            if (action === 'add') {
                document.getElementById('userModalLabel').textContent = '사용자 추가';
                document.getElementById('userIdInput').disabled = false;
                
                // 기본 종료일은 30일 후로 설정
                const endDate = new Date();
                endDate.setDate(endDate.getDate() + 30);
                document.getElementById('userEndDate').value = endDate.toISOString().split('T')[0];
            } else {
                document.getElementById('userModalLabel').textContent = '사용자 수정';
                document.getElementById('userIdInput').disabled = true;
            }
        }
        
        // 사용자 수정 모달 열기
        async function editUser(userId) {
            resetUserForm('edit');
            
            const token = checkAuth();
            if (!token) return;
            
            try {
                const response = await fetch('/api/users', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('사용자 정보를 불러오는데 실패했습니다.');
                }
                
                const data = await response.json();
                const user = data.users.find(u => u.id === userId);
                
                if (user) {
                    document.getElementById('userId').value = user.id;
                    document.getElementById('userIdInput').value = user.id;
                    document.getElementById('userPwInput').value = user.pw;
                    document.getElementById('userEndDate').value = user.end_date;
                    document.getElementById('userName').value = user.name || '';
                    document.getElementById('userPhone').value = user.phone || '';
                    document.getElementById('userReferrer').value = user.referrer || '';
                    
                    userModal.show();
                }
            } catch (error) {
                console.error('사용자 정보 로드 오류:', error);
            }
        }
        
        // 사용자 저장 (추가/수정)
        async function saveUser() {
            const token = checkAuth();
            if (!token) return;
            
            const action = document.getElementById('userAction').value;
            const userId = action === 'edit' ? document.getElementById('userId').value : document.getElementById('userIdInput').value;
            
            const userData = {
                id: document.getElementById('userIdInput').value,
                pw: document.getElementById('userPwInput').value,
                end_date: document.getElementById('userEndDate').value,
                name: document.getElementById('userName').value,
                phone: document.getElementById('userPhone').value,
                referrer: document.getElementById('userReferrer').value
            };
            
            try {
                let url = '/api/users';
                let method = 'POST';
                
                if (action === 'edit') {
                    url = `/api/users/${userId}`;
                    method = 'PUT';
                    // PUT 요청에서는 id 필드 제외
                    delete userData.id;
                }
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });
                
                if (!response.ok) {
                    throw new Error(action === 'add' ? '사용자 추가 실패' : '사용자 수정 실패');
                }
                
                userModal.hide();
                loadUsers();
                
                // 성공 알림
                alert(action === 'add' ? '사용자가 추가되었습니다.' : '사용자 정보가 수정되었습니다.');
                
            } catch (error) {
                console.error('사용자 저장 오류:', error);
                alert(error.message);
            }
        }
        
        // 삭제 확인 모달 표시
        function showDeleteConfirmation(userId) {
            document.getElementById('deleteUserId').textContent = userId;
            deleteModal.show();
        }
        
        // 사용자 삭제
        async function deleteUser() {
            const token = checkAuth();
            if (!token) return;
            
            const userId = document.getElementById('deleteUserId').textContent;
            
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('사용자 삭제 실패');
                }
                
                deleteModal.hide();
                loadUsers();
                
                // 성공 알림
                alert('사용자가 삭제되었습니다.');
                
            } catch (error) {
                console.error('사용자 삭제 오류:', error);
                alert(error.message);
            }
        }
    </script>
</body>

</html>